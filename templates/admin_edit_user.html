{% extends "base.html" %}

{% block title %}Edit User - {{ target_user.full_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <div>
            <h1><i class="fas fa-user-edit"></i> Edit User</h1>
            <p class="page-subtitle">Update user information and settings</p>
        </div>
        <div class="header-actions">
            <a href="/admin/users" class="btn btn-outline">
                <i class="fas fa-arrow-left"></i> Back to Users
            </a>
        </div>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-user"></i> User Information</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="/admin/users/{{ target_user.id }}/edit" id="editUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="full_name" class="form-label">Full Name *</label>
                                <input type="text" id="full_name" name="full_name" class="form-control" 
                                       value="{{ target_user.full_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="username" class="form-label">Username *</label>
                                <input type="text" id="username" name="username" class="form-control" 
                                       value="{{ target_user.username }}" required>
                                <small class="text-muted">Username must be unique</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">Email Address *</label>
                        <input type="email" id="email" name="email" class="form-control" 
                               value="{{ target_user.email }}" required>
                        <small class="text-muted">Email must be unique</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="role" class="form-label">User Role *</label>
                                <select id="role" name="role" class="form-control form-select" required>
                                    <option value="admin" {{ 'selected' if target_user.role == 'admin' else '' }}>Administrator</option>
                                    <option value="vendor" {{ 'selected' if target_user.role == 'vendor' else '' }}>Vendor</option>
                                    <option value="buyer" {{ 'selected' if target_user.role == 'buyer' else '' }}>Buyer</option>
                                </select>
                                <small class="text-muted">Be careful when changing user roles</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <div class="form-check" style="margin-top: 32px;">
                                    <input type="checkbox" id="is_active" name="is_active" class="form-check-input" 
                                           {{ 'checked' if target_user.is_active else '' }}>
                                    <label for="is_active" class="form-check-label">
                                        <strong>Active Account</strong>
                                        <small class="text-muted d-block">User can login and access the system</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="form-label">New Password</label>
                        <input type="password" id="password" name="password" class="form-control" 
                               placeholder="Leave blank to keep current password">
                        <small class="text-muted">Only enter a password if you want to change it</small>
                    </div>

                    <div class="form-group">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" class="form-control" 
                               placeholder="Confirm new password">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <a href="/admin/users" class="btn btn-outline">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                        {% if target_user.role != 'admin' %}
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <i class="fas fa-trash"></i> Delete User
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-info-circle"></i> User Details</h3>
            </div>
            <div class="card-body">
                <div class="user-stats">
                    <div class="stat-item">
                        <label>User ID</label>
                        <span>#{{ target_user.id }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <label>Registration Date</label>
                        <span>{{ target_user.created_at.strftime('%B %d, %Y') if target_user.created_at else 'Unknown' }}</span>
                    </div>
                    
                    <div class="stat-item">
                        <label>Current Role</label>
                        <span class="badge badge-{{ 'danger' if target_user.role == 'admin' else 'primary' if target_user.role == 'vendor' else 'info' }}">
                            {{ target_user.role.title() }}
                        </span>
                    </div>
                    
                    <div class="stat-item">
                        <label>Account Status</label>
                        {% if target_user.is_active %}
                            <span class="badge badge-success">Active</span>
                        {% else %}
                            <span class="badge badge-danger">Inactive</span>
                        {% endif %}
                    </div>
                    
                    <div class="stat-item">
                        <label>Last Login</label>
                        <span>{{ target_user.last_login.strftime('%B %d, %Y') if target_user.last_login else 'Never' }}</span>
                    </div>
                    
                    {% if target_user.role == 'vendor' %}
                    <div class="stat-item">
                        <label>Vendor Status</label>
                        <span class="badge badge-info">Vendor Account</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3><i class="fas fa-cog"></i> Quick Actions</h3>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    {% if target_user.role == 'vendor' %}
                    <a href="/admin/vendors?user_id={{ target_user.id }}" class="btn btn-outline btn-block">
                        <i class="fas fa-store"></i> View Vendor Profile
                    </a>
                    {% endif %}
                    
                    {% if target_user.role == 'buyer' %}
                    <a href="/admin/orders?buyer_id={{ target_user.id }}" class="btn btn-outline btn-block">
                        <i class="fas fa-shopping-cart"></i> View Orders
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-outline btn-block" onclick="resetPassword()">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                    
                    <button class="btn btn-outline btn-block" onclick="sendNotification()">
                        <i class="fas fa-bell"></i> Send Notification
                    </button>
                    
                    {% if target_user.is_active %}
                    <button class="btn btn-warning btn-block" onclick="suspendUser()">
                        <i class="fas fa-ban"></i> Suspend Account
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-block" onclick="activateUser()">
                        <i class="fas fa-check"></i> Activate Account
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        {% if target_user.role != 'admin' %}
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
            </div>
            <div class="card-body">
                <p class="text-muted small">These actions cannot be undone. Please be careful.</p>
                <button class="btn btn-danger btn-block" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete User
                </button>
                <button class="btn btn-warning btn-block" onclick="banUser()" style="margin-top: 10px;">
                    <i class="fas fa-gavel"></i> Permanently Ban
                </button>
            </div>
        </div>
        {% endif %}
        
        <div class="card" style="margin-top: 20px;">
            <div class="card-header">
                <h3><i class="fas fa-shield-alt"></i> Security Info</h3>
            </div>
            <div class="card-body">
                <div class="security-info">
                    <div class="info-item">
                        <label>Password Last Changed</label>
                        <span class="text-muted">Unknown</span>
                    </div>
                    <div class="info-item">
                        <label>Failed Login Attempts</label>
                        <span class="text-muted">0</span>
                    </div>
                    <div class="info-item">
                        <label>Account Locked</label>
                        <span class="badge badge-success">No</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone and will remove all associated data.')) {
        fetch('/admin/users/{{ target_user.id }}/delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('User deleted successfully!');
                window.location.href = '/admin/users';
            } else {
                alert('Error deleting user: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting user');
        });
    }
}

function resetPassword() {
    const newPassword = prompt('Enter new password for this user:');
    if (newPassword && newPassword.length >= 6) {
        document.getElementById('password').value = newPassword;
        document.getElementById('confirm_password').value = newPassword;
        alert('Password fields have been filled. Click "Save Changes" to update.');
    } else if (newPassword) {
        alert('Password must be at least 6 characters long.');
    }
}

function suspendUser() {
    if (confirm('Suspend this user account? They will not be able to login.')) {
        document.getElementById('is_active').checked = false;
        document.getElementById('editUserForm').submit();
    }
}

function activateUser() {
    if (confirm('Activate this user account? They will be able to login again.')) {
        document.getElementById('is_active').checked = true;
        document.getElementById('editUserForm').submit();
    }
}

function sendNotification() {
    alert('Send Notification feature - Coming soon!');
}

function banUser() {
    if (confirm('Permanently ban this user? This will delete their account and prevent future registrations with this email.')) {
        confirmDelete();
    }
}

// Form validation
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password && password !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match!');
        return;
    }
    
    if (password && password.length < 6) {
        e.preventDefault();
        alert('Password must be at least 6 characters long!');
        return;
    }
    
    const requiredFields = ['full_name', 'username', 'email', 'role'];
    let isValid = true;
    
    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
            input.style.borderColor = '#dc3545';
            isValid = false;
        } else {
            input.style.borderColor = '';
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields.');
    }
});

// Real-time password confirmation
document.getElementById('confirm_password').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (password && confirmPassword && password !== confirmPassword) {
        this.style.borderColor = '#dc3545';
    } else {
        this.style.borderColor = '';
    }
});
</script>

<style>
.user-stats .stat-item,
.security-info .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.user-stats .stat-item:last-child,
.security-info .info-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.user-stats .stat-item label,
.security-info .info-item label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0;
    font-weight: 600;
}

.quick-actions .btn {
    margin-bottom: 10px;
}

.quick-actions .btn:last-child {
    margin-bottom: 0;
}

.form-check-label small {
    font-size: 0.8rem;
}

.danger-zone {
    background-color: #fdf2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 15px;
}
</style>
{% endblock %} 