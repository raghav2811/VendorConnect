{% extends "base.html" %}

{% block title %}My Orders - {{ user.full_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <div>
            <h1><i class="fas fa-shopping-cart"></i> My Orders</h1>
            <p class="page-subtitle">Manage incoming orders and track deliveries</p>
        </div>
        <div class="header-actions">
            <div class="filter-buttons">
                <button class="btn btn-outline active filter-btn" data-status="all">All Orders</button>
                <button class="btn btn-outline filter-btn" data-status="pending">Pending</button>
                <button class="btn btn-outline filter-btn" data-status="confirmed">Confirmed</button>
                <button class="btn btn-outline filter-btn" data-status="preparing">Preparing</button>
                <button class="btn btn-outline filter-btn" data-status="ready">Ready</button>
                <button class="btn btn-outline filter-btn" data-status="delivered">Delivered</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Stats -->
<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-number">{{ orders|length }}</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-content">
            <div class="stat-number">0</div>
            <div class="stat-label">Pending Orders</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-clock"></i>
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-content">
            <div class="stat-number">0</div>
            <div class="stat-label">Today's Revenue</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-rupee-sign"></i>
        </div>
    </div>
    
    <div class="stat-card info">
        <div class="stat-content">
            <div class="stat-number">0</div>
            <div class="stat-label">Avg. Order Value</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
        </div>
    </div>
</div>

<!-- Orders List -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-list"></i> Recent Orders</h3>
        <div class="card-actions">
            <div class="search-box">
                <input type="text" placeholder="Search orders..." id="searchInput">
            </div>
            <select id="dateFilter" class="form-control form-select">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        {% if orders %}
        <div class="orders-list">
            {% for order in orders %}
            <div class="order-card" data-status="{{ order.status }}" data-date="{{ order.created_at or order.order_date }}">
                <div class="order-header">
                    <div class="order-info">
                        <h4>{{ order.order_number or ('Order #' ~ order.id) }}</h4>
                        <p class="order-time">
                            {% if order.created_at %}
                                {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') if order.created_at.strftime else order.created_at }}
                            {% elif order.order_date %}
                                {{ order.order_date.strftime('%B %d, %Y at %I:%M %p') if order.order_date.strftime else order.order_date }}
                            {% else %}
                                Recent
                            {% endif %}
                        </p>
                    </div>
                    <div class="order-status">
                        <span class="badge badge-{{ order.status }}">{{ order.status.title() }}</span>
                        <div class="order-total">₹{{ order.total_amount or '0' }}</div>
                    </div>
                </div>
                
                <div class="order-details">
                    <div class="customer-info">
                        <h5><i class="fas fa-user"></i> Customer Details</h5>
                        <p><strong>Name:</strong> {{ order.buyer.full_name if order.buyer else 'N/A' }}</p>
                        <p><strong>Phone:</strong> {{ order.buyer.phone if order.buyer and order.buyer.phone else 'N/A' }}</p>
                        <p><strong>Address:</strong> {{ order.delivery_address or 'N/A' }}</p>
                        {% if order.notes %}
                        <p><strong>Notes:</strong> {{ order.notes }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="order-items">
                        <h5><i class="fas fa-utensils"></i> Order Items</h5>
                        <div class="items-list">
                            {% if order.items %}
                                {% for item in order.items %}
                                <div class="item">
                                    <span class="item-name">{{ item.menu_item.name if item.menu_item else 'Item' }}</span>
                                    <span class="item-qty">x{{ item.quantity }}</span>
                                    <span class="item-price">₹{{ item.total_price or (item.unit_price * item.quantity) }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="item">
                                    <span class="item-name">No items details available</span>
                                    <span class="item-qty"></span>
                                    <span class="item-price"></span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="order-actions">
                    {% if order.status == 'pending' %}
                        <button class="btn btn-success btn-sm" onclick="updateOrderStatus({{ order.id }}, 'confirmed')">
                            <i class="fas fa-check"></i> Accept Order
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="updateOrderStatus({{ order.id }}, 'cancelled')">
                            <i class="fas fa-times"></i> Reject Order
                        </button>
                    {% elif order.status == 'confirmed' %}
                        <button class="btn btn-primary btn-sm" onclick="updateOrderStatus({{ order.id }}, 'preparing')">
                            <i class="fas fa-fire"></i> Start Preparing
                        </button>
                    {% elif order.status == 'preparing' %}
                        <button class="btn btn-warning btn-sm" onclick="updateOrderStatus({{ order.id }}, 'ready')">
                            <i class="fas fa-bell"></i> Mark Ready
                        </button>
                    {% elif order.status == 'ready' %}
                        <button class="btn btn-info btn-sm" onclick="updateOrderStatus({{ order.id }}, 'delivered')">
                            <i class="fas fa-truck"></i> Out for Delivery
                        </button>
                    {% elif order.status == 'delivered' %}
                        <span class="text-success"><i class="fas fa-check-circle"></i> Completed</span>
                    {% endif %}
                    
                    <button class="btn btn-outline btn-sm" onclick="viewOrderDetails({{ order.id }})">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="printOrder({{ order.id }})">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h3>No Orders Yet</h3>
            <p>You haven't received any orders yet. Make sure your menu is complete and your business is approved!</p>
            <div class="empty-actions">
                <a href="/vendor/menu" class="btn btn-primary">
                    <i class="fas fa-utensils"></i> Manage Menu
                </a>
                <a href="/vendor/profile" class="btn btn-outline">
                    <i class="fas fa-store"></i> Update Profile
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Stats -->
<div class="card" style="margin-top: 30px;">
    <div class="card-header">
        <h3><i class="fas fa-chart-bar"></i> Order Analytics</h3>
    </div>
    <div class="card-body">
        <div class="analytics-grid">
            <div class="analytic-item">
                <label>Peak Hours</label>
                <span class="text-muted">12:00 PM - 2:00 PM</span>
            </div>
            <div class="analytic-item">
                <label>Most Popular Item</label>
                <span class="text-muted">No data yet</span>
            </div>
            <div class="analytic-item">
                <label>Average Preparation Time</label>
                <span class="text-muted">25 minutes</span>
            </div>
            <div class="analytic-item">
                <label>Customer Rating</label>
                <span class="text-muted">
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star text-warning"></i>
                    <i class="fas fa-star-half-alt text-warning"></i>
                    4.5
                </span>
            </div>
        </div>
    </div>
</div>

<style>
.filter-buttons {
    display: flex;
    gap: 10px;
}

.filter-buttons .btn.active {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card.warning {
    border-left: 4px solid var(--warning-color);
}

.stat-card.success {
    border-left: 4px solid var(--success-color);
}

.stat-card.info {
    border-left: 4px solid var(--info-color);
}

.card-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-box input {
    width: 250px;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--glass-gradient);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    color: var(--text-primary);
    position: relative;
    z-index: 1;
}

.search-box input::placeholder {
    color: var(--text-muted);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2), var(--glow);
}

.orders-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.order-card {
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 20px;
    background: var(--glass-gradient);
    backdrop-filter: blur(var(--backdrop-blur));
    -webkit-backdrop-filter: blur(var(--backdrop-blur));
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.order-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent);
    pointer-events: none;
}

.order-card:hover {
    box-shadow: var(--shadow-lg), var(--glow);
    transform: translateY(-5px);
    border-color: rgba(139, 92, 246, 0.3);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    z-index: 2;
}

.order-details {
    position: relative;
    z-index: 2;
}

.order-actions {
    position: relative;
    z-index: 2;
}

.order-info h4 {
    color: var(--text-primary);
    text-shadow: 0 1px 5px rgba(139, 92, 246, 0.2);
}

.order-time {
    color: var(--text-secondary);
}

.order-total {
    color: var(--text-primary);
    font-weight: 600;
    text-shadow: 0 1px 5px rgba(139, 92, 246, 0.3);
}

.customer-info h5,
.order-items h5 {
    color: var(--text-primary);
    text-shadow: 0 1px 5px rgba(139, 92, 246, 0.2);
}

.items-list .item {
    background: var(--glass-hover);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.order-info h4 {
    margin: 0 0 5px 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.order-time {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.9rem;
}

.order-status {
    text-align: right;
}

.order-total {
    font-size: 1.1rem;
    font-weight: 600;
    margin-top: 5px;
}

.order-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.customer-info h5,
.order-items h5 {
    margin: 0 0 10px 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.customer-info p {
    margin: 5px 0;
    font-size: 0.9rem;
}

.items-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9rem;
}

.item-name {
    flex: 1;
}

.item-qty {
    margin: 0 10px;
    color: var(--text-muted);
}

.item-price {
    font-weight: 600;
}

.order-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 4rem;
    color: var(--border-color);
    margin-bottom: 20px;
}

.empty-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 20px;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.analytic-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.analytic-item label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0;
}

@media (max-width: 768px) {
    .filter-buttons {
        flex-wrap: wrap;
    }
    
    .card-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .search-box input {
        width: 100%;
    }
    
    .order-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .order-status {
        text-align: left;
    }
    
    .order-details {
        grid-template-columns: 1fr;
    }
    
    .order-actions {
        flex-direction: column;
    }
    
    .empty-actions {
        flex-direction: column;
        align-items: center;
    }
}
</style>

<script>
// Filter functionality
document.querySelectorAll('.filter-buttons .btn').forEach(button => {
    button.addEventListener('click', function() {
        // Update active button
        document.querySelectorAll('.filter-buttons .btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Filter orders
        const status = this.dataset.status;
        filterOrders(status);
    });
});

function filterOrders(status) {
    const orders = document.querySelectorAll('.order-card');
    orders.forEach(order => {
        if (status === 'all' || order.dataset.status === status) {
            order.style.display = 'block';
        } else {
            order.style.display = 'none';
        }
    });
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const orders = document.querySelectorAll('.order-card');
    
    orders.forEach(order => {
        const orderText = order.textContent.toLowerCase();
        if (orderText.includes(searchTerm)) {
            order.style.display = 'block';
        } else {
            order.style.display = 'none';
        }
    });
});

// Order management functions
function updateOrderStatus(orderId, newStatus) {
    if (confirm(`Are you sure you want to update this order to ${newStatus}?`)) {
        // API call placeholder
        fetch(`/vendor/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating order status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating order status');
        });
    }
}

function viewOrderDetails(orderId) {
    alert(`Order details for #${orderId} - Feature coming soon!`);
}

function printOrder(orderId) {
    alert(`Print order #${orderId} - Feature coming soon!`);
}

// Auto-refresh orders every 30 seconds
// Enhanced order status update function
async function updateOrderStatus(orderId, newStatus) {
    if (!confirm(`Are you sure you want to change this order status to "${newStatus}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Order status updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(result.message || 'Failed to update order status');
        }
    } catch (error) {
        console.error('Error updating order status:', error);
        showNotification('Error updating order status', 'error');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

// Order filtering
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const status = this.dataset.status;
        document.querySelectorAll('.order-card').forEach(card => {
            if (status === 'all' || card.dataset.status === status) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });
});

// Auto-refresh every 30 seconds
setInterval(() => {
    if (!document.hidden) {
        location.reload();
    }
}, 30000);
</script>

<style>
/* Enhanced Order Card Styles */
.order-card {
    background: var(--glass-gradient);
    backdrop-filter: blur(var(--backdrop-blur));
    -webkit-backdrop-filter: blur(var(--backdrop-blur));
    border: 1px solid var(--border-color);
    border-radius: 20px;
    box-shadow: var(--shadow);
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

.order-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.05), transparent);
    pointer-events: none;
}

.order-card:hover {
    box-shadow: var(--shadow-lg), var(--glow);
    transform: translateY(-5px);
    border-color: rgba(139, 92, 246, 0.3);
}

.badge-pending { 
    background: rgba(245, 158, 11, 0.2); 
    color: #f59e0b; 
    border: 1px solid rgba(245, 158, 11, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.badge-confirmed { 
    background: rgba(6, 182, 212, 0.2); 
    color: #06b6d4; 
    border: 1px solid rgba(6, 182, 212, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.badge-preparing { 
    background: rgba(239, 68, 68, 0.2); 
    color: #ef4444; 
    border: 1px solid rgba(239, 68, 68, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.badge-ready { 
    background: rgba(16, 185, 129, 0.2); 
    color: #10b981; 
    border: 1px solid rgba(16, 185, 129, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.badge-delivered { 
    background: rgba(139, 92, 246, 0.2); 
    color: var(--primary-color); 
    border: 1px solid rgba(139, 92, 246, 0.3);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--glass-gradient);
    backdrop-filter: blur(var(--backdrop-blur));
    -webkit-backdrop-filter: blur(var(--backdrop-blur));
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 15px 20px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 10000;
}

.notification.show { transform: translateX(0); }
.notification-success { border-left: 4px solid var(--success); color: var(--success); }
.notification-error { border-left: 4px solid var(--danger); color: var(--danger); }
</style>
{% endblock %} 