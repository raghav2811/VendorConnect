{% extends "base.html" %}

{% block title %}Analytics & Reports - Vendor Management System{% endblock %}

{% block page_title %}Business Analytics & Reports{% endblock %}
{% block page_description %}Real-time insights and comprehensive business analytics{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i>
    {{ error }}
</div>
{% endif %}

<!-- Executive Summary Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-content">
            <div class="stat-number">₹{{ "%.2f"|format(financial_summary.total_revenue if financial_summary.total_revenue else 0) }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-content">
            <div class="stat-number">{{ sales_analytics.total_orders if sales_analytics.total_orders else 0 }}</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
    </div>
    
    <div class="stat-card warning">
        <div class="stat-content">
            <div class="stat-number">{{ customer_analytics.total_customers if customer_analytics.total_customers else 0 }}</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
    </div>
    
    <div class="stat-card danger">
        <div class="stat-content">
            <div class="stat-number">{{ inventory_analytics.low_stock_count if inventory_analytics.low_stock_count else 0 }}</div>
            <div class="stat-label">Low Stock Items</div>
        </div>
        <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
    </div>
</div>

<!-- Performance Metrics Row -->
<div class="row" style="margin-bottom: 30px;">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie text-primary"></i>
                    Sales Performance
                </h3>
            </div>
            <div style="padding: 24px;">
                <div class="metric-item">
                    <span class="metric-label">This Month Sales</span>
                    <span class="metric-value text-success">₹{{ "%.2f"|format(sales_analytics.this_month_sales if sales_analytics.this_month_sales else 0) }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Average Order Value</span>
                    <span class="metric-value text-primary">₹{{ "%.2f"|format(sales_analytics.average_order_value if sales_analytics.average_order_value else 0) }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Monthly Growth</span>
                    <span class="metric-value {{ 'text-success' if financial_summary.growth_rate and financial_summary.growth_rate > 0 else 'text-danger' }}">
                        {{ "%.1f"|format(financial_summary.growth_rate if financial_summary.growth_rate else 0) }}%
                    </span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">This Month Orders</span>
                    <span class="metric-value text-info">{{ sales_analytics.this_month_orders if sales_analytics.this_month_orders else 0 }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-boxes text-warning"></i>
                    Inventory Analytics
                </h3>
            </div>
            <div style="padding: 24px;">
                <div class="metric-item">
                    <span class="metric-label">Total Stock Items</span>
                    <span class="metric-value text-primary">{{ inventory_analytics.total_stock_items if inventory_analytics.total_stock_items else 0 }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Stock Value</span>
                    <span class="metric-value text-success">₹{{ "%.2f"|format(inventory_analytics.total_stock_value if inventory_analytics.total_stock_value else 0) }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Stock Efficiency</span>
                    <span class="metric-value text-info">{{ "%.1f"|format(inventory_analytics.stock_efficiency if inventory_analytics.stock_efficiency else 100) }}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Critical Stock</span>
                    <span class="metric-value text-danger">{{ inventory_analytics.critical_stock_count if inventory_analytics.critical_stock_count else 0 }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-friends text-info"></i>
                    Customer Insights
                </h3>
            </div>
            <div style="padding: 24px;">
                <div class="metric-item">
                    <span class="metric-label">Active Customers</span>
                    <span class="metric-value text-success">{{ customer_analytics.active_customers if customer_analytics.active_customers else 0 }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">New This Month</span>
                    <span class="metric-value text-primary">{{ customer_analytics.new_customers_this_month if customer_analytics.new_customers_this_month else 0 }}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Retention Rate</span>
                    <span class="metric-value text-info">{{ "%.1f"|format(customer_analytics.retention_rate if customer_analytics.retention_rate else 0) }}%</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">Avg Orders/Customer</span>
                    <span class="metric-value text-warning">{{ "%.1f"|format(customer_analytics.avg_orders_per_customer if customer_analytics.avg_orders_per_customer else 0) }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Reports Row -->
<div class="row" style="margin-bottom: 30px;">
    <!-- Low Stock Report -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle text-warning"></i>
                    Low Stock Alert
                </h3>
                <span class="badge badge-warning">{{ low_stock_report|length }} Items</span>
            </div>
            
            {% if low_stock_report %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Current</th>
                                <th>Reorder Level</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in low_stock_report[:10] %}
                            <tr>
                                <td>
                                    <strong>{{ item.item_name }}</strong>
                                    <br><small class="text-muted">{{ item.vendor.name if item.vendor else 'N/A' }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-{{ 'danger' if item.current_stock == 0 else 'warning' }}">
                                        {{ item.current_stock }} {{ item.unit }}
                                    </span>
                                </td>
                                <td>{{ item.reorder_level }} {{ item.unit }}</td>
                                <td>
                                    {% if item.current_stock == 0 %}
                                        <span class="badge badge-danger">Critical</span>
                                    {% else %}
                                        <span class="badge badge-warning">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="text-success">All Stock Levels Normal</h3>
                    <p>No items are currently below reorder level.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Vendor Performance -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-building text-primary"></i>
                    Vendor Performance
                </h3>
            </div>
            
            {% if vendor_performance %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Orders</th>
                                <th>Revenue</th>
                                <th>Avg Order</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vendor in vendor_performance[:10] %}
                            <tr>
                                <td>
                                    <strong>{{ vendor.vendor_name }}</strong>
                                </td>
                                <td>
                                    <span class="badge badge-primary">{{ vendor.total_orders }}</span>
                                </td>
                                <td>
                                    <strong>₹{{ "%.2f"|format(vendor.total_amount) }}</strong>
                                </td>
                                <td>
                                    ₹{{ "%.2f"|format(vendor.average_order_value) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>No Performance Data</h3>
                    <p>Vendor performance data will appear as orders are placed.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Monthly Transaction Trends -->
<div class="card" style="margin-bottom: 30px;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-chart-area text-primary"></i>
            Monthly Transaction Trends
        </h3>
    </div>
    
    {% if monthly_transactions %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Stock In</th>
                        <th>Stock Out</th>
                        <th>Adjustments</th>
                        <th>Net Change</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month in monthly_transactions %}
                    <tr>
                        <td>
                            <strong>{{ month.month }}</strong>
                        </td>
                        <td>
                            <span class="badge badge-success">+{{ month.total_in }}</span>
                        </td>
                        <td>
                            <span class="badge badge-danger">-{{ month.total_out }}</span>
                        </td>
                        <td>
                            <span class="badge badge-warning">{{ month.total_adjustments }}</span>
                        </td>
                        <td>
                            <span class="badge badge-{{ 'success' if month.net_change >= 0 else 'danger' }}">
                                {{ "+" if month.net_change >= 0 else "" }}{{ month.net_change }}
                            </span>
                        </td>
                        <td>
                            {% if month.net_change > 0 %}
                                <i class="fas fa-arrow-up text-success"></i>
                            {% elif month.net_change < 0 %}
                                <i class="fas fa-arrow-down text-danger"></i>
                            {% else %}
                                <i class="fas fa-minus text-warning"></i>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h3>No Transaction Data</h3>
            <p>Monthly trends will appear once you start recording transactions.</p>
        </div>
    {% endif %}
</div>

<!-- Advanced Analytics -->
<div class="row" style="margin-bottom: 30px;">
    <!-- Order Status Distribution -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-donut text-info"></i>
                    Order Status Distribution
                </h3>
            </div>
            <div style="padding: 24px;">
                {% if sales_analytics.status_distribution %}
                    {% for status, count in sales_analytics.status_distribution.items() %}
                    <div class="status-item">
                        <div class="status-info">
                            <span class="status-label">{{ status.title() }}</span>
                            <span class="status-count">{{ count }} orders</span>
                        </div>
                        <div class="status-bar">
                            <div class="status-progress" style="width: {{ (count / sales_analytics.total_orders * 100) if sales_analytics.total_orders > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h4>No Order Data</h4>
                        <p>Order status distribution will appear as orders are placed.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Key Performance Indicators -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-tachometer-alt text-primary"></i>
                    Key Performance Indicators
                </h3>
            </div>
            <div style="padding: 24px;">
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div class="kpi-label">Revenue Growth</div>
                        <div class="kpi-value {{ 'text-success' if financial_summary.growth_rate and financial_summary.growth_rate > 0 else 'text-danger' }}">
                            {{ "%.1f"|format(financial_summary.growth_rate if financial_summary.growth_rate else 0) }}%
                        </div>
                        <div class="kpi-description">Monthly change</div>
                    </div>
                    
                    <div class="kpi-item">
                        <div class="kpi-label">Customer Retention</div>
                        <div class="kpi-value text-info">
                            {{ "%.1f"|format(customer_analytics.retention_rate if customer_analytics.retention_rate else 0) }}%
                        </div>
                        <div class="kpi-description">Repeat customers</div>
                    </div>
                    
                    <div class="kpi-item">
                        <div class="kpi-label">Inventory Efficiency</div>
                        <div class="kpi-value text-warning">
                            {{ "%.1f"|format(inventory_analytics.stock_efficiency if inventory_analytics.stock_efficiency else 100) }}%
                        </div>
                        <div class="kpi-description">Stock optimization</div>
                    </div>
                    
                    <div class="kpi-item">
                        <div class="kpi-label">Average Transaction</div>
                        <div class="kpi-value text-primary">
                            ₹{{ "%.2f"|format(financial_summary.avg_transaction_value if financial_summary.avg_transaction_value else 0) }}
                        </div>
                        <div class="kpi-description">Per order value</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export and Actions -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-download text-primary"></i>
            Export & Actions
        </h3>
        <div class="card-actions">
            <small class="text-muted">
                Report generated: {{ report_generated_at.split('T')[0] if report_generated_at else 'N/A' }}
            </small>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 24px;">
        <button class="btn btn-primary" onclick="exportReport('comprehensive')">
            <i class="fas fa-file-pdf"></i>
            Export Full Report
        </button>
        <button class="btn btn-success" onclick="exportReport('financial')">
            <i class="fas fa-file-excel"></i>
            Financial Summary
        </button>
        <button class="btn btn-warning" onclick="exportReport('inventory')">
            <i class="fas fa-file-csv"></i>
            Inventory Report
        </button>
        <button class="btn btn-info" onclick="exportReport('customer')">
            <i class="fas fa-file-alt"></i>
            Customer Analytics
        </button>
        <button class="btn btn-secondary" onclick="refreshReports()">
            <i class="fas fa-sync-alt"></i>
            Refresh Data
        </button>
        <button class="btn btn-outline" onclick="window.print()">
            <i class="fas fa-print"></i>
            Print Report
        </button>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Custom styles for reports */
.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.metric-item:last-child {
    border-bottom: none;
}

.metric-label {
    font-weight: 500;
    color: var(--text-secondary);
}

.metric-value {
    font-weight: 600;
    font-size: 1.1rem;
}

.status-item {
    margin-bottom: 16px;
}

.status-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.status-label {
    font-weight: 500;
    color: var(--text-primary);
}

.status-count {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.status-bar {
    height: 6px;
    background: var(--glass-gradient);
    border-radius: 3px;
    overflow: hidden;
}

.status-progress {
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border-radius: 3px;
    transition: width 0.3s ease;
}

.kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.kpi-item {
    text-align: center;
    padding: 16px;
    background: var(--glass-gradient);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.kpi-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.kpi-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 4px;
    text-shadow: 0 2px 8px rgba(139, 92, 246, 0.2);
}

.kpi-description {
    font-size: 0.8rem;
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .kpi-grid {
        grid-template-columns: 1fr;
    }
    
    .metric-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Export functionality
function exportReport(reportType) {
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    btn.disabled = true;
    
    // Simulate export process
    setTimeout(() => {
        alert(`${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report export will be implemented in the next version.`);
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 1500);
}

// Refresh reports data
function refreshReports() {
    if (confirm('This will reload the page to fetch the latest data. Continue?')) {
        location.reload();
    }
}

// Auto-refresh reports every 10 minutes
setTimeout(function() {
    if (confirm('Report data may be outdated. Refresh now?')) {
        location.reload();
    }
}, 600000);

// Add tooltips and interactivity
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for metrics
    const metricValues = document.querySelectorAll('.metric-value, .kpi-value');
    metricValues.forEach(metric => {
        metric.style.cursor = 'help';
        metric.addEventListener('click', function() {
            const label = this.parentElement.querySelector('.metric-label, .kpi-label').textContent;
            showMetricInfo(label, this.textContent);
        });
    });
    
    // Add status bar animations
    const statusBars = document.querySelectorAll('.status-progress');
    statusBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });
});

function showMetricInfo(label, value) {
    let info = '';
    switch(label) {
        case 'Total Revenue':
            info = 'Total revenue generated from all completed orders across all vendors.';
            break;
        case 'Revenue Growth':
            info = 'Percentage change in revenue compared to the previous month.';
            break;
        case 'Customer Retention':
            info = 'Percentage of customers who have placed more than one order.';
            break;
        case 'Stock Efficiency':
            info = 'Percentage of stock items that are above their reorder level.';
            break;
        case 'Average Transaction':
            info = 'Average order value across all completed transactions.';
            break;
        default:
            info = `Current value: ${value}`;
    }
    
    alert(info);
}

// Print optimization
window.addEventListener('beforeprint', function() {
    document.body.classList.add('print-mode');
});

window.addEventListener('afterprint', function() {
    document.body.classList.remove('print-mode');
});
</script>
{% endblock %} 